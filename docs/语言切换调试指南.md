# 语言切换调试指南

## 问题描述

**症状**: 窗口语言不会根据选择变化，重新选择后才会变化。

**具体表现**:
1. 在菜单中选择语言（如：中文 → English）
2. 菜单栏语言更新了
3. 但窗口内容语言没有立即更新
4. 需要再次选择才会更新

## 调试步骤

### 1. 查看控制台日志

启动应用并打开开发者工具：

**方法1**: 在 main.js 中添加
```javascript
mainWindow.webContents.openDevTools();
```

**方法2**: 运行应用后按 `Ctrl+Shift+I` (Windows/Linux) 或 `Cmd+Option+I` (macOS)

### 2. 切换语言并观察日志

在菜单中切换语言，应该看到：

```
Language changed to: en-US
Updating UI text...
updateUIText called, current locale: en-US
updateUIText completed
UI text updated
```

### 3. 检查问题

#### 情况1: 没有任何日志

**原因**: 监听器未注册或消息未发送

**检查**:
1. 确认 `window.electronAPI.onLanguageChanged` 存在
2. 确认 main.js 中 `mainWindow.webContents.send('language-changed', language)` 被调用
3. 检查 preload.js 中的 IPC 通道

#### 情况2: 有日志但界面未更新

**原因**: updateUIText() 函数有问题

**检查**:
1. 确认 i18n.t() 返回正确的翻译
2. 确认元素有 data-i18n 属性
3. 检查是否有 JavaScript 错误

#### 情况3: 部分更新

**原因**: 某些元素没有 data-i18n 属性或更新逻辑不完整

**检查**:
1. 检查哪些元素没有更新
2. 确认这些元素有 data-i18n 属性
3. 检查 updateUIText() 是否处理了这些元素类型

## 已添加的调试代码

### renderer.js

```javascript
// 监听器中的日志
window.electronAPI.onLanguageChanged((language) => {
  console.log('Language changed to:', language);
  i18n.setLocale(language);
  settings.language = language;
  console.log('Updating UI text...');
  updateUIText();
  console.log('UI text updated');
});

// updateUIText 中的日志
function updateUIText() {
  console.log('updateUIText called, current locale:', i18n.getLocale());
  // ... 更新逻辑
  console.log('updateUIText completed');
}
```

## 可能的问题和解决方案

### 问题1: IPC 通道未正确设置

**检查 preload.js**:
```javascript
contextBridge.exposeInMainWorld('electronAPI', {
  // 确认这个方法存在
  onLanguageChanged: (callback) =>
    ipcRenderer.on('language-changed', (event, language) => callback(language)),
});
```

**检查 main.js**:
```javascript
function changeLanguage(language) {
  // ...
  if (mainWindow && !mainWindow.isDestroyed()) {
    mainWindow.webContents.send('language-changed', language);
  }
}
```

### 问题2: i18n 未正确初始化

**检查 renderer.js 初始化**:
```javascript
// 确认这些行存在
i18n.registerLocale('zh-CN', zhCN);
i18n.registerLocale('en-US', enUS);
```

**测试 i18n**:
在控制台中运行：
```javascript
i18n.setLocale('en-US');
console.log(i18n.t('buttons.start')); // 应该输出 "Start"

i18n.setLocale('zh-CN');
console.log(i18n.t('buttons.start')); // 应该输出 "开始"
```

### 问题3: 元素缺少 data-i18n 属性

**检查 HTML**:
```html
<!-- 正确 -->
<button data-i18n="buttons.start">开始</button>

<!-- 错误 - 缺少 data-i18n -->
<button>开始</button>
```

**查找缺少属性的元素**:
在控制台中运行：
```javascript
// 查找所有按钮
document.querySelectorAll('button').forEach(btn => {
  if (!btn.hasAttribute('data-i18n')) {
    console.log('Missing data-i18n:', btn.textContent);
  }
});
```

### 问题4: 动态创建的元素

**问题**: 动态创建的元素没有 data-i18n 属性

**解决**: 在创建元素时添加属性或手动更新文本

```javascript
// 方法1: 添加 data-i18n 属性
const button = document.createElement('button');
button.setAttribute('data-i18n', 'buttons.start');
button.textContent = i18n.t('buttons.start');

// 方法2: 在 updateUIText 中手动更新
function updateUIText() {
  // ... 其他更新

  // 手动更新动态元素
  if (dynamicButton) {
    dynamicButton.textContent = i18n.t('buttons.start');
  }
}
```

### 问题5: 选择器 option 元素

**问题**: select 的 option 元素可能需要特殊处理

**已修复**: 在 updateUIText 中添加了 OPTION 的特殊处理

```javascript
if (element.tagName === 'OPTION') {
  element.textContent = text;
}
```

## 测试方法

### 手动测试

1. **启动应用**
   ```bash
   npm start
   ```

2. **打开开发者工具**
   - 按 `Ctrl+Shift+I`

3. **切换语言**
   - 菜单 → 语言 → English
   - 观察控制台日志
   - 检查界面是否更新

4. **再次切换**
   - 菜单 → Language → 简体中文
   - 观察控制台日志
   - 检查界面是否更新

### 自动化测试

在控制台中运行：

```javascript
// 测试语言切换
async function testLanguageSwitch() {
  console.log('Testing language switch...');

  // 切换到英文
  i18n.setLocale('en-US');
  updateUIText();
  console.log('Switched to English');
  console.log('Start button:', document.querySelector('[data-i18n="buttons.start"]').textContent);

  // 等待1秒
  await new Promise(resolve => setTimeout(resolve, 1000));

  // 切换到中文
  i18n.setLocale('zh-CN');
  updateUIText();
  console.log('Switched to Chinese');
  console.log('Start button:', document.querySelector('[data-i18n="buttons.start"]').textContent);
}

testLanguageSwitch();
```

## 预期结果

### 正常情况

**控制台输出**:
```
Language changed to: en-US
Updating UI text...
updateUIText called, current locale: en-US
updateUIText completed
UI text updated
```

**界面变化**:
- ✅ 所有按钮文本更新为英文
- ✅ 所有标签文本更新为英文
- ✅ 所有下拉选项更新为英文
- ✅ 状态文本更新为英文

### 异常情况

**没有日志输出**:
- 问题：监听器未注册或消息未发送
- 解决：检查 IPC 通道设置

**有日志但界面未更新**:
- 问题：updateUIText() 逻辑有误
- 解决：检查元素选择器和更新逻辑

**部分元素未更新**:
- 问题：某些元素缺少 data-i18n 属性
- 解决：添加缺失的属性

## 移除调试代码

测试完成后，可以移除调试日志：

```javascript
// 移除这些 console.log
window.electronAPI.onLanguageChanged((language) => {
  // console.log('Language changed to:', language);
  i18n.setLocale(language);
  settings.language = language;
  // console.log('Updating UI text...');
  updateUIText();
  // console.log('UI text updated');
});

function updateUIText() {
  // console.log('updateUIText called, current locale:', i18n.getLocale());
  // ...
  // console.log('updateUIText completed');
}
```

## 相关文件

- **main.js**: `changeLanguage()` 函数
- **preload.js**: `onLanguageChanged` IPC 通道
- **src/renderer.js**: 语言切换监听器和 `updateUIText()` 函数
- **src/index.html**: 元素的 data-i18n 属性
- **src/i18n/zh-CN.js**: 中文翻译
- **src/i18n/en-US.js**: 英文翻译

## 总结

### 已添加的改进

- ✅ 添加详细的调试日志
- ✅ 添加 OPTION 元素的特殊处理
- ✅ 改进错误检测

### 下一步

1. 运行应用并查看日志
2. 根据日志输出定位问题
3. 如果问题仍然存在，提供完整的日志输出

---

**更新日期**: 2026-02-06
**版本**: 1.0
**状态**: 调试中
