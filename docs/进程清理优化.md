# 进程清理优化

## 问题描述

在 Windows 任务管理器中发现，程序关闭后仍有进程残留，导致系统资源占用。

## 问题原因

1. **FFmpeg 进程未终止**
   - 当应用关闭时，如果 FFmpeg 正在处理视频，进程会继续运行
   - 没有存储 FFmpeg 命令的引用，无法在清理时终止

2. **MediaRecorder 流未停止**
   - 录制窗口的媒体流（stream）没有正确清理
   - 媒体轨道（tracks）在窗口关闭时仍在运行

3. **IPC 监听器未移除**
   - 注册的 IPC 事件监听器没有被清理
   - 导致内存泄漏和进程无法正常退出

4. **缺少退出前处理**
   - 应用没有 `before-quit` 和 `will-quit` 处理器
   - 无法确保在退出前完成所有清理工作

## 解决方案

### 1. recorder.js 改进

#### 1.1 添加 FFmpeg 进程引用
```javascript
class ScreenRecorder {
  constructor() {
    // ...
    this.ffmpegCommand = null; // 存储 FFmpeg 命令引用
    this.ipcListeners = []; // 存储 IPC 监听器
  }
}
```

#### 1.2 改进 convertToMP4 方法
- 将 FFmpeg 命令存储到 `this.ffmpegCommand`
- 在完成或出错时清除引用

#### 1.3 改进 cleanup 方法
```javascript
cleanup() {
  // 终止正在运行的 FFmpeg 进程
  if (this.ffmpegCommand) {
    this.ffmpegCommand.kill('SIGKILL');
    this.ffmpegCommand = null;
  }
}
```

#### 1.4 改进 destroy 方法
- 停止正在进行的录制
- 移除所有 IPC 监听器
- 通知录制窗口清理流
- 关闭录制窗口

#### 1.5 改进 setupListeners 方法
- 将监听器函数存储为命名函数
- 保存监听器引用到数组中
- 便于在 destroy 时移除

### 2. recording.html 改进

#### 2.1 添加 cleanupStreams 函数
```javascript
function cleanupStreams() {
  // 停止 MediaRecorder
  if (mediaRecorder && mediaRecorder.state !== 'inactive') {
    mediaRecorder.stop();
  }

  // 停止所有媒体轨道
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
    stream = null;
  }
}
```

#### 2.2 添加清理监听器
- 监听 `cleanup-streams` IPC 事件
- 监听 `beforeunload` 窗口事件

#### 2.3 修复 stream 变量作用域
- 将 `const stream` 改为使用外部的 `stream` 变量
- 确保 stream 可以在清理时访问

### 3. main.js 改进

#### 3.1 添加 before-quit 处理器
```javascript
app.on('before-quit', (event) => {
  // 销毁录制器
  if (recorder) {
    recorder.destroy();
  }

  // 关闭所有窗口
  if (selectorWindow && !selectorWindow.isDestroyed()) {
    selectorWindow.destroy();
  }

  if (mainWindow && !mainWindow.isDestroyed()) {
    mainWindow.destroy();
  }
});
```

#### 3.2 添加 will-quit 处理器
- 作为最后的清理机会
- 确保录制器被完全销毁

## 优化效果

### 改进前
- ❌ FFmpeg 进程在应用关闭后继续运行
- ❌ MediaRecorder 流未停止，占用摄像头/屏幕资源
- ❌ IPC 监听器未移除，导致内存泄漏
- ❌ 任务管理器中可见残留进程

### 改进后
- ✅ FFmpeg 进程在应用关闭时被强制终止
- ✅ 所有媒体流和轨道被正确停止
- ✅ IPC 监听器被完全移除
- ✅ 应用退出时所有资源被清理
- ✅ 任务管理器中无残留进程

## 测试建议

### 测试场景 1：正常关闭
1. 启动应用
2. 选择录制区域
3. 开始录制
4. 关闭应用
5. 检查任务管理器，确认无残留进程

### 测试场景 2：录制中关闭
1. 启动应用并开始录制
2. 在录制过程中关闭应用
3. 检查任务管理器，确认 FFmpeg 进程已终止

### 测试场景 3：处理中关闭
1. 完成一次录制
2. 在视频处理（FFmpeg 转换）过程中关闭应用
3. 检查任务管理器，确认 FFmpeg 进程已终止

### 测试场景 4：强制关闭
1. 启动应用并开始录制
2. 使用任务管理器强制结束主进程
3. 检查是否有子进程残留

## 技术细节

### FFmpeg 进程终止
- 使用 `SIGKILL` 信号强制终止进程
- 确保即使在异常情况下也能终止

### IPC 监听器管理
- 使用命名函数而不是匿名函数
- 保存函数引用以便后续移除
- 使用 `ipcMain.removeListener()` 移除监听器

### 媒体流清理
- 遍历所有轨道并调用 `stop()`
- 清空 stream 引用
- 重置 MediaRecorder 状态

### 多层清理保障
1. `window-all-closed` - 窗口关闭时
2. `before-quit` - 应用退出前
3. `will-quit` - 应用即将退出时
4. `beforeunload` - 窗口卸载前（渲染进程）

## 注意事项

1. **日志输出**：添加了详细的日志输出，便于调试和监控清理过程

2. **错误处理**：所有清理操作都包含 try-catch，避免清理过程中的错误导致应用无法退出

3. **状态检查**：在操作窗口前检查 `isDestroyed()`，避免操作已销毁的窗口

4. **跨平台兼容**：清理逻辑在 Windows、macOS 和 Linux 上都能正常工作

## 相关文件

- `recorder.js` - 录制器类，负责 FFmpeg 和 IPC 清理
- `src/recording.html` - 录制窗口，负责媒体流清理
- `main.js` - 主进程，负责应用生命周期管理

## 版本信息

- 修复版本：1.0.1
- 修复日期：2026-02-06
- 相关 Issue：进程残留问题
